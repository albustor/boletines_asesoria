<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boletines Informativos - Asesoría Nacional</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Open Sans', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Loader Spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- NAVEGACIÓN -->
    <nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <!-- Logo / Título -->
                <div class="flex items-center gap-3 cursor-pointer" onclick="app.setView('public')">
                    <div class="bg-white/10 p-2 rounded-lg">
                        <i data-lucide="book-open" class="text-blue-200 w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">Boletines Informativos</h1>
                        <p class="text-[10px] text-blue-300 uppercase tracking-wider font-bold">Alberto Bustos Ortega</p>
                        <p class="text-[9px] text-blue-400 uppercase tracking-wider">Asesor Nacional de Formación Tecnológica</p>
                    </div>
                </div>
                
                <!-- Controles Derecha -->
                <div class="flex items-center gap-4" id="nav-controls">
                    <!-- Se llena dinámicamente con JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main id="main-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
        <!-- El contenido se inyecta aquí (Vista Pública o Admin) -->
        <div class="flex justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
    </main>

    <!-- MODAL PREVIEW -->
    <div id="preview-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-6xl h-[90vh] rounded-xl overflow-hidden flex flex-col shadow-2xl">
            <div class="bg-gray-100 px-6 py-4 flex justify-between items-center border-b border-gray-200">
                <div>
                    <h2 id="modal-title" class="font-bold text-gray-800 text-lg">Título</h2>
                    <p id="modal-date" class="text-xs text-gray-500">Fecha</p>
                </div>
                <div class="flex gap-3">
                    <button id="btn-download-modal" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                        <i data-lucide="download" class="w-4 h-4"></i> Descargar Recurso
                    </button>
                    <button onclick="app.closeModal()" class="p-2 hover:bg-gray-200 rounded-full transition text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 bg-gray-50 relative">
                <iframe id="modal-iframe" class="w-full h-full border-0" sandbox="allow-scripts"></iframe>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="mt-12 py-8 bg-white border-t border-gray-200 text-center space-y-1">
        <p class="text-gray-700 font-bold text-lg">Alberto José Bustos Ortega</p>
        <p class="text-gray-600 text-sm font-medium">Asesor Nacional de Informática Educativa</p>
        <p class="text-gray-500 text-sm">Programa Nacional de Formación Tecnológica</p>
        <p class="text-gray-500 text-sm">Dirección de Recursos Tecnológicos en Educación</p>
        <a href="mailto:alberto.bustos.ortega@mep.go.cr" class="text-blue-600 text-sm hover:underline block mt-2">alberto.bustos.ortega@mep.go.cr</a>
        <p class="text-gray-400 text-xs mt-4 font-mono">2026</p>
    </footer>

    <!-- LOGICA JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Configuración Firebase ---
        
        // 1. Intentar obtener configuración automática (Entorno Canvas)
        let firebaseConfig = {};
        let appId = 'default-app-id';
        
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } catch (e) {
            console.warn("No se detectó configuración automática de entorno.");
        }

        // --- ÁREA DE CONFIGURACIÓN PERSONAL (Para GitHub) ---
        // Si vas a subir esto a GitHub Pages, debes crear un proyecto en Firebase y pegar tus datos aquí.
        // Si 'firebaseConfig' está vacío (porque estamos fuera del Canvas), usaremos estos datos:
        if (Object.keys(firebaseConfig).length === 0) {
            firebaseConfig = {
                apiKey: "AIzaSyCJCrvyQY2ipUSWMsjM5TAXLDL991sUNm4",
                authDomain: "boletines-pnft.firebaseapp.com",
                projectId: "boletines-pnft",
                storageBucket: "boletines-pnft.firebasestorage.app",
                messagingSenderId: "666480084275",
                appId: "1:666480084275:web:d075a6f8b2b166fcb12a46"
            };
            
            // IMPORTANTE: ID único para tu repositorio de boletines en producción
            appId = 'boletines-pnft-main';
        }
        // --------------------------------------------------------

        let appFirebase;
        let auth;
        let db;
        let isConfigured = false;

        // Inicialización segura
        try {
            if (firebaseConfig.apiKey) {
                appFirebase = initializeApp(firebaseConfig);
                auth = getAuth(appFirebase);
                db = getFirestore(appFirebase);
                isConfigured = true;
            } else {
                console.error("Falta la configuración de Firebase.");
            }
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
        }

        // --- Estado de la Aplicación ---
        const state = {
            user: null,
            view: 'public', // 'public', 'admin'
            isAdminMode: false, // Nuevo estado para controlar el acceso admin por PIN
            bulletins: [],
            filterMonth: 'Todos',
            searchTerm: '',
            deletingIds: new Set(),
            loading: true,
            error: null, // Nuevo estado para errores
            errorMessage: ''
        };

        const months = ['Todos', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const monthsInput = months.slice(1); // Para el select del admin (sin 'Todos')

        // --- Funciones Principales ---

        window.app = {
            setView: (viewName) => {
                state.view = viewName;
                render();
            },
            setFilterMonth: (month) => {
                state.filterMonth = month;
                renderPublicContent();
            },
            setSearchTerm: (term) => {
                state.searchTerm = term;
                renderPublicContent();
            },
            // NUEVA FUNCIÓN: Solicitar acceso admin
            requestAdminAccess: () => {
                const password = prompt("Ingrese la contraseña de administrador:");
                if (password === "mep2026") { // Contraseña simple
                    state.isAdminMode = true;
                    state.view = 'admin';
                    alert("Acceso concedido. Ahora puedes gestionar los boletines.");
                    render();
                } else if (password !== null) {
                    alert("Contraseña incorrecta.");
                }
            },
            exitAdminMode: () => {
                state.isAdminMode = false;
                state.view = 'public';
                render();
            },
            openModal: (bulletinId) => {
                const bulletin = state.bulletins.find(b => b.id === bulletinId);
                if (!bulletin) return;
                
                document.getElementById('modal-title').textContent = bulletin.title;
                document.getElementById('modal-date').textContent = bulletin.dateDisplay;
                document.getElementById('modal-iframe').srcdoc = bulletin.htmlContent;
                
                // Configurar botón de descarga
                const btn = document.getElementById('btn-download-modal');
                btn.onclick = () => app.downloadHTML(bulletin.id);

                const modal = document.getElementById('preview-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            },
            closeModal: () => {
                const modal = document.getElementById('preview-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.getElementById('modal-iframe').srcdoc = '';
            },
            downloadHTML: (id) => {
                const bulletin = state.bulletins.find(b => b.id === id);
                if (!bulletin) {
                    alert('Error: No se encontró el boletín.');
                    return;
                }
                const element = document.createElement("a");
                const file = new Blob([bulletin.htmlContent], {type: 'text/html'});
                element.href = URL.createObjectURL(file);
                element.download = `${bulletin.title.replace(/\s+/g, '_')}.html`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            },
            logout: () => signOut(auth),
            
            // --- Acciones de Admin ---
            handlePublish: async (e) => {
                e.preventDefault();
                if (!isConfigured) { alert("Error: Firebase no está configurado."); return; }

                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Publicando...';

                try {
                    const title = document.getElementById('input-title').value;
                    const month = document.getElementById('input-month').value;
                    const summary = document.getElementById('input-summary').value;
                    const htmlContent = document.getElementById('input-html').value;
                    const today = new Date();

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'boletines_pnft'), {
                        title,
                        summary,
                        month,
                        year: today.getFullYear(),
                        dateDisplay: today.toLocaleDateString(),
                        htmlContent,
                        timestamp: serverTimestamp(),
                        authorId: state.user ? state.user.uid : 'anon-admin'
                    });

                    // Limpiar formulario
                    e.target.reset();
                    // Volver a vista pública
                    app.setView('public');
                    // alert('Boletín publicado exitosamente.'); // Opcional

                } catch (error) {
                    console.error("Error publishing:", error);
                    alert("Error al publicar: " + error.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            },
            handleDelete: async (id) => {
                if (!isConfigured) return;
                if (!confirm("¿Estás seguro de eliminar este boletín?")) return;
                
                state.deletingIds.add(id);
                renderAdminContent(); // Re-render para mostrar spinner

                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'boletines_pnft', id));
                } catch (error) {
                    alert("Error al eliminar: " + error.message);
                    console.error(error);
                } finally {
                    state.deletingIds.delete(id);
                    renderAdminContent();
                }
            },
            pasteFromClipboard: async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('input-html').value = text;
                } catch (err) {
                    alert('No se pudo acceder al portapapeles. Por favor pega manualmente con Ctrl+V.');
                }
            }
        };

        // --- Renderizado UI ---

        function render() {
            renderNav();
            
            const main = document.getElementById('main-container');
            
            // Caso: Error de Configuración
            if (!isConfigured) {
                // ... (mismo mensaje de error) ...
                main.innerHTML = `<div class="p-10 text-center">Configuración Firebase Requerida</div>`; 
                return;
            }

            // Caso: Error de Permisos (Firebase Rules)
            if (state.error === 'permission-denied') {
                main.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 text-center max-w-2xl mx-auto px-4">
                        <div class="bg-red-100 p-4 rounded-full mb-6">
                            <i data-lucide="shield-alert" class="w-12 h-12 text-red-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Acceso Denegado por Firebase</h2>
                        <p class="text-gray-600 mb-6 leading-relaxed">
                            Las reglas de seguridad de tu proyecto en la nube están bloqueando la conexión.
                            Esto es normal en proyectos nuevos.
                        </p>
                        
                        <div class="bg-white p-6 rounded-xl border-l-4 border-red-500 shadow-md text-left w-full space-y-4">
                            <h3 class="font-bold text-gray-800">Cómo solucionarlo (Paso a Paso):</h3>
                            
                            <div class="space-y-2">
                                <p class="text-sm font-semibold text-gray-700">1. Habilitar Modo de Prueba:</p>
                                <p class="text-sm text-gray-600 ml-4">
                                    Ve a <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">Firebase Console</a> > Firestore Database > <strong>Reglas</strong>.<br>
                                    Cambia el código a: <code>allow read, write: if true;</code> y dale a <strong>Publicar</strong>.
                                </p>
                            </div>

                            <div class="space-y-2">
                                <p class="text-sm font-semibold text-gray-700">2. Habilitar Auth Anónima:</p>
                                <p class="text-sm text-gray-600 ml-4">
                                    Ve a Authentication > Sign-in method > <strong>Anónimo</strong> y actívalo.
                                </p>
                            </div>
                        </div>
                        <button onclick="location.reload()" class="mt-8 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            Ya lo arreglé, recargar página
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

             // Caso: Error de Autenticación
             if (state.error === 'auth-error') {
                main.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 text-center max-w-2xl mx-auto px-4">
                        <div class="bg-orange-100 p-4 rounded-full mb-6">
                            <i data-lucide="user-x" class="w-12 h-12 text-orange-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Error de Autenticación</h2>
                        <p class="text-gray-600 mb-6">No se pudo iniciar sesión anónima en Firebase.</p>
                        <div class="bg-white p-4 rounded-lg border border-orange-200 text-left text-sm text-gray-700">
                            <strong>Detalle:</strong> ${state.errorMessage}<br><br>
                            <strong>Solución:</strong> Ve a Firebase Console > Authentication > Sign-in method y asegúrate de que el proveedor "Anónimo" esté <strong>Habilitado</strong>.
                        </div>
                         <button onclick="location.reload()" class="mt-8 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Reintentar
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }


            if (state.loading) {
                main.innerHTML = `
                    <div class="flex justify-center py-20">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    </div>`;
                return;
            }

            if (state.view === 'public') {
                renderPublicContent();
            } else if (state.view === 'admin') {
                renderAdminContent();
            }
            
            lucide.createIcons();
        }

        function renderNav() {
            const container = document.getElementById('nav-controls');
            if (!isConfigured) {
                container.innerHTML = `<span class="text-xs text-yellow-300 font-bold bg-yellow-900/30 px-2 py-1 rounded">Sin Conexión</span>`;
                return;
            }

            // MODIFICADO: Lógica de navegación basada en modo Admin (PIN)
            if (state.isAdminMode) {
                container.innerHTML = `
                    <span class="text-xs bg-green-500/20 text-green-200 px-2 py-1 rounded border border-green-500/50 mr-2">Modo Admin Activo</span>
                    <button onclick="app.setView('public')" class="text-blue-200 hover:text-white mr-2" title="Vista Pública">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                    </button>
                    <button onclick="app.exitAdminMode()" class="text-blue-200 hover:text-red-300 flex items-center gap-1" title="Salir de Admin">
                        <i data-lucide="log-out" class="w-5 h-5"></i> Salir
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <button onclick="app.requestAdminAccess()" class="text-xs text-blue-300 hover:text-white flex items-center gap-1 bg-blue-800/50 px-3 py-1.5 rounded-full transition hover:bg-blue-700">
                        <i data-lucide="lock" class="w-3 h-3"></i> Acceso Admin
                    </button>
                `;
            }
            lucide.createIcons();
        }

        function renderPublicContent() {
            const main = document.getElementById('main-container');
            
            // Filtros
            const filtered = state.bulletins.filter(b => {
                const matchesMonth = state.filterMonth === 'Todos' || b.month === state.filterMonth;
                const matchesSearch = b.title.toLowerCase().includes(state.searchTerm.toLowerCase()) || 
                                      (b.summary && b.summary.toLowerCase().includes(state.searchTerm.toLowerCase()));
                return matchesMonth && matchesSearch;
            });

            // Generar HTML de filtros
            const monthsHtml = months.map(m => `
                <button onclick="app.setFilterMonth('${m}')" 
                    class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${state.filterMonth === m ? 'bg-blue-100 text-blue-700 ring-2 ring-blue-500' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'}">
                    ${m}
                </button>
            `).join('');

            const headerHtml = `
                <div class="space-y-8 fade-in">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute right-0 top-0 opacity-10 transform translate-x-10 -translate-y-10">
                            <i data-lucide="book-open" class="w-48 h-48"></i>
                        </div>
                        <div class="relative z-10 max-w-2xl">
                            <h2 class="text-3xl font-bold mb-4">Recursos Educativos e Infográficos</h2>
                            <p class="text-blue-100 text-lg leading-relaxed mb-6">
                                Acceso centralizado a los boletines diarios de Formación Tecnológica recolectados, analizados, seleccionados y distribuidos utilizando IA (con validación de Alberto). Material descargable para docentes de la modalidad de secundaria, enfocado en Dimensión 1, 2 y Dimensión 1 y 2.
                            </p>
                        </div>
                    </div>

                    <!-- Buscador y Filtros -->
                    <div class="flex flex-col md:flex-row gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-20 z-40">
                        <div class="flex-1 relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                            <input type="text" placeholder="Buscar por título o tema..." 
                                value="${state.searchTerm}"
                                oninput="app.setSearchTerm(this.value)"
                                class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div class="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0 scrollbar-hide">
                            ${monthsHtml}
                        </div>
                    </div>

                    <!-- Grid -->
                    ${filtered.length === 0 ? `
                        <div class="text-center py-20 bg-white rounded-2xl border border-dashed border-gray-300">
                            <i data-lucide="file-code" class="mx-auto text-gray-300 w-12 h-12 mb-4"></i>
                            <p class="text-gray-500">No se encontraron boletines con los filtros actuales.</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${filtered.map(item => `
                                <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col overflow-hidden group h-full">
                                    <div class="h-3 bg-blue-500 w-full"></div>
                                    <div class="p-6 flex-1 flex flex-col">
                                        <div class="flex justify-between items-start mb-4">
                                            <span class="bg-blue-50 text-blue-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">
                                                ${item.month} ${item.year}
                                            </span>
                                            <span class="text-gray-400 text-xs flex items-center gap-1">
                                                <i data-lucide="calendar" class="w-3 h-3"></i> ${item.dateDisplay}
                                            </span>
                                        </div>
                                        <h3 class="font-bold text-xl text-gray-800 mb-2 leading-snug group-hover:text-blue-600 transition">
                                            ${item.title}
                                        </h3>
                                        <p class="text-gray-500 text-sm mb-6 line-clamp-3 flex-1">
                                            ${item.summary || "Infográfico interactivo con recursos para Formación Tecnológica."}
                                        </p>
                                        <div class="flex gap-3 mt-auto pt-4 border-t border-gray-100">
                                            <button onclick="app.openModal('${item.id}')" class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gray-50 hover:bg-blue-50 text-gray-700 hover:text-blue-700 border border-gray-200 hover:border-blue-200 rounded-lg text-sm font-medium transition">
                                                <i data-lucide="eye" class="w-4 h-4"></i> Ver
                                            </button>
                                            <button onclick="app.downloadHTML('${item.id}')" class="flex items-center justify-center p-2 bg-gray-50 hover:bg-green-50 text-gray-600 hover:text-green-600 border border-gray-200 hover:border-green-200 rounded-lg transition" title="Descargar HTML">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
            main.innerHTML = headerHtml;
            lucide.createIcons();
        }

        function renderAdminContent() {
            const main = document.getElementById('main-container');
            const monthsOptions = monthsInput.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // Listado de gestión
            const listItems = state.bulletins.map(b => {
                // MODIFICADO: En modo Admin (PIN), tienes poder absoluto, ignoramos el authorId
                const canDelete = state.isAdminMode;
                const isDeleting = state.deletingIds.has(b.id);
                
                let btnAction = '';
                if (canDelete) {
                    if (isDeleting) {
                        btnAction = `<span class="spinner"></span>`;
                    } else {
                        btnAction = `<button onclick="app.handleDelete('${b.id}')" class="text-gray-400 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    }
                } else {
                    btnAction = `<span class="text-gray-300 p-2" title="Solo lectura"><i data-lucide="lock" class="w-4 h-4"></i></span>`;
                }

                return `
                    <div class="p-3 border border-gray-100 rounded-lg bg-gray-50 hover:bg-white hover:shadow-sm transition flex justify-between items-center group">
                        <div class="overflow-hidden">
                            <p class="text-sm font-bold text-gray-700 truncate">${b.title}</p>
                            <p class="text-xs text-gray-400">${b.dateDisplay}</p>
                        </div>
                        ${btnAction}
                    </div>
                `;
            }).join('') || '<p class="text-sm text-gray-400 italic">No hay boletines publicados.</p>';

            main.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
                    <!-- Formulario -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-xl border border-blue-200 shadow-lg">
                            <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                                <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                                    <i data-lucide="upload" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">Publicar Nuevo Boletín</h2>
                                    <p class="text-sm text-gray-500">Copia el código HTML generado por Gemini y pégalo aquí.</p>
                                </div>
                            </div>

                            <form onsubmit="app.handlePublish(event)" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Título del Boletín</label>
                                        <input type="text" id="input-title" required placeholder="Ej: Innovación en IoT - 15 Ene"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
                                        <select id="input-month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                            ${monthsOptions}
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Resumen Corto</label>
                                    <input type="text" id="input-summary" placeholder="Breve descripción..."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 flex justify-between">
                                        <span>Código HTML (Gemini)</span>
                                        <span class="text-xs text-blue-600 cursor-pointer hover:underline" onclick="app.pasteFromClipboard()">Pegar del portapapeles</span>
                                    </label>
                                    <textarea id="input-html" required rows="10" placeholder="<html>... Pega aquí el código ...</html>"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                                </div>

                                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white shadow-md transition disabled:bg-gray-400">
                                    Publicar en Repositorio
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Lista Gestión -->
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4 text-gray-400"></i> Gestionar Contenido
                            </h3>
                            <div class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                                ${listItems}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- Inicialización ---

        // Autenticación
        const initAuth = async () => {
            if (!isConfigured) return;

            try {
                const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                state.error = 'auth-error';
                state.errorMessage = error.message;
                render();
            }
        };

        // Listeners
        if (isConfigured) {
            initAuth();
            
            onAuthStateChanged(auth, (u) => {
                state.user = u;
                // Siempre cargamos datos, sea anónimo o no
                if (u) {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'boletines_pnft'));
                    onSnapshot(q, (snapshot) => {
                        const data = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        state.bulletins = data;
                        state.loading = false;
                        state.error = null; // Clear any previous error
                        render();
                    }, (error) => {
                        console.error(error);
                         if (error.code === 'permission-denied') {
                            state.error = 'permission-denied';
                            state.loading = false;
                            render();
                        } else {
                            state.loading = false;
                            render();
                        }
                    });
                } else {
                    // Si falla auth, aún intentamos mostrar UI (aunque Firestore fallará)
                    state.loading = false;
                    render();
                }
            });
        } else {
            render();
        }

    </script>
</body>
</html>
